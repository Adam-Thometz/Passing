<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <title>Passing</title>
</head>
<style>
body {
  margin: 0;
  width: 100%;
  height: 100%;
  background-color: #000000;
  overflow: hidden;
  position: relative;
}

#loader {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #00000055;
  /* display: flex; */
  justify-content: center;
  align-items: center;
  display: none;
  z-index: 10;
}

.loader-text-wrapper {
  font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
  padding: 32px;
  background-color: #FFFFFF55;
  display: flex;
  flex-direction: column;
}

.sound {
  transition-duration: 300ms;
}

#cymbal .sound {
  position: absolute;
  z-index: 2;
  top: 50vh;
  left: 50vw;
  transform: translate(-50%, -50%);
  height: 100px;
  width: 100px;
  transform: scale(0);
  border-radius: 50%;
  background: radial-gradient(circle at 50% 50%, #FFE2FF 0%, #F8D1FF 100%);
  opacity: 0.5;
}

#synths .sound {
  position: absolute;
  top: 0;
  height: 100vh;
  width: 100vw;
  z-index: 0;
}

#hiHat .sound {
  background-color: #920000;
  position: absolute;
  top: 0;
  height: 150vh;
  width: 150vw;
  opacity: 0;
  z-index: 5;
}

#snare .sound {
  position: absolute;
  z-index: 1;
  top: 5vh;
  right: 5%;
  height: 100px;
  width: 100px;
  transform: scale(0);
  border-radius: 50%;
  background: radial-gradient(circle at 50% 50%, #EE82EE 0%, #FFFF00 100%);
  opacity: 0.3;
  animation: zigzag 20s ease-in-out infinite both;
}

#kick .sound {
  position: absolute;
  z-index: 1;
  top: -3vh;
  left: 50%;
  height: 75px;
  width: 15%;
  transform: translateX(-50%) scale(0);
  border-radius: 50%;
  background: linear-gradient(90deg, #386FAF 0%, #0076D4 49%, #0062FF 100%);
  opacity: 0.3;
}

#bass .sound {
  position: absolute;
  z-index: 2;
  top: 100vh;
  left: 50%;
  transform: translateX(-50%);
  height: 100px;
  width: 15%;
  transform: scale(0);
  border-radius: 50%;
  background: radial-gradient(circle at 50% 50%, #b10000 0%, #e97612 100%);
  opacity: 0.5;
}

#controls {
  position: absolute;
  bottom: -100vh;
  left: 50%;
  height: 10vh;
  transform: translateX(-50%);
  /* width: 100vw; */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 50;
}

#playPause {
  height: 100%;
  width: 5vw;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #00000000;
  border: none;
  font-size: 3rem;
  cursor: pointer;
  border-radius: 50%;
}

#playPause:focus {
  box-shadow: 0px 0px 5px 1px  #03FFC3, inset 0px 0px 5px 1px  #03FFC3;
  outline: none;
}

#playPause i {
  color:  #03FFC3;
  opacity: 1;
}

#reset {
  height: 100%;
  width: 5vw;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #00000000;
  border: none;
  font-size: 3rem;
  cursor: pointer;
  border-radius: 50%;
}

#reset:focus {
  box-shadow: 0px 0px 5px 1px  #03FFC3, inset 0px 0px 5px 1px  #03FFC3;
  outline: none;
}

#reset i {
  color:  #03FFC3;
  opacity: 1;
}

#stars {
  position: absolute;
  display: flex;
  top: 0;
  left: 0;
  width: 200vw;
  height: 100vh;
  opacity: 0;
  z-index: 10;
}

#glass {
  position: fixed;
  background-image: url(https://adam-thometz.s3.us-east-2.amazonaws.com/passing/textures/glass-texture.png);
  display: flex;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  opacity: 0;
  z-index: 10;
}

#stars div {
  background-image: url(https://adam-thometz.s3.us-east-2.amazonaws.com/passing/textures/galaxy.svg);
  width: 100%;
  height: 100%;
}

.star1 {
  white-space: nowrap;
  animation: star_slide1 60s linear infinite;
  animation-delay: calc(60s * -1);
}
.star2 {
  animation: star_slide2 60s linear infinite;
  animation-delay: calc(60s / -2);
}

@keyframes star_slide1 {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(-100%);
  }
}

@keyframes star_slide2 {
  from {
    transform: translateX(0%);
  }
  to {
    transform: translateX(-200%);
  }
}

@keyframes zigzag {
  from {
    right: 5%;
  }
  50% {
    right: 95%;
  }
  to {
    right: 5%;
  }
}
</style>
<body>
  <div id="loader">
    <div class="loader-text-wrapper">
      <p id="loaderText">Oops, we had a hiccup. Wait a few seconds and press Play</p>
    </div>
  </div>
  <div id="stars">
    <div class="star1"></div>
    <div class="star2"></div>
  </div>
  <div id="glass"></div>
  <div id="cymbal">
    <div class="sound"></div>
    <audio
      src="https://adam-thometz.s3.us-east-2.amazonaws.com/passing/audio/cymbal.mp3"
      crossorigin="anonymous"
    ></audio>
  </div>
  <div id="synths">
    <div class="sound"></div>
    <audio
      src="https://adam-thometz.s3.us-east-2.amazonaws.com/passing/audio/synths.mp3"
      crossorigin="anonymous"
    ></audio>
  </div>
  <div id="hiHat">
    <div class="sound"></div>
    <audio
      src="https://adam-thometz.s3.us-east-2.amazonaws.com/passing/audio/hi-hat.mp3"
      crossorigin="anonymous"
    ></audio>
  </div>
  <div id="snare">
    <div class="sound"></div>
    <audio
      src="https://adam-thometz.s3.us-east-2.amazonaws.com/passing/audio/snare-drum.mp3"
      crossorigin="anonymous"
    ></audio>
  </div>
  <div id="kick">
    <div class="sound"></div>
    <audio
      src="https://adam-thometz.s3.us-east-2.amazonaws.com/passing/audio/kick-drum.mp3"
      crossorigin="anonymous"
    ></audio>
  </div>
  <div id="bass">
    <div class="sound"></div>
    <audio
      src="https://adam-thometz.s3.us-east-2.amazonaws.com/passing/audio/bass.mp3"
      crossorigin="anonymous"
    ></audio>
  </div>

  <div id="controls">
    <button id="playPause"></button>
    <button id="reset">
      <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><path d="M40 224c-13.3 0-24-10.7-24-24V56c0-13.3 10.7-24 24-24s24 10.7 24 24v80.1l20-23.5C125 63.4 186.9 32 256 32c123.7 0 224 100.3 224 224s-100.3 224-224 224c-50.4 0-97-16.7-134.4-44.8c-10.6-8-12.7-23-4.8-33.6s23-12.7 33.6-4.8C179.8 418.9 216.3 432 256 432c97.2 0 176-78.8 176-176s-78.8-176-176-176c-54.3 0-102.9 24.6-135.2 63.4l-.1 .2 0 0L93.1 176H184c13.3 0 24 10.7 24 24s-10.7 24-24 24H40z"/></svg>
    </button>
  </div>
</body>
<script>
const AUDIO_BLOCKS = [
  document.getElementById("cymbal"),
  document.getElementById("synths"),
  document.getElementById("hiHat"),
  document.getElementById("snare"),
  document.getElementById("kick"),
  document.getElementById("bass"),
];

const STARS = document.getElementById("stars")
const GLASS = document.getElementById("glass")
const LOADING_SCREEN = document.getElementById("loader")

const PLAY_PAUSE_BTN = document.getElementById("playPause");
const RESET_BTN = document.getElementById("reset");
const PLAY_ICON = `<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><style>svg{fill:#03ffc3}</style><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg>`;
const PAUSE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 320 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><style>svg{fill:#03ffc3}</style><path d="M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48H80c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z"/></svg>`;

const SCALES = {
  cymbal: 0.75,
  synths: 3,
  hiHat: 1.2,
  snare: 0.2,
  kick: 1,
  bass: 0.3,
};

let isPlaying = false
let animationIds = AUDIO_BLOCKS.reduce(function createKeyForAnimationId(accum, val) {
  accum[val.id] = null;
  return accum;
}, {});
let context = new AudioContext();
const sources = {};

(function init() {
  AUDIO_BLOCKS.forEach(function createMediaSource(block) {
    const id = block.id;
    const music = getAudioTrack(block);
    const analyser = context.createAnalyser();
    const source = context.createMediaElementSource(music);
    source.connect(analyser);
    analyser.connect(context.destination);
    sources[id] = analyser;
    music.load()
    music.addEventListener('canplaythrough', () => {
      console.log('lets goooo', id)
    })
  });
  PLAY_PAUSE_BTN.innerHTML = PLAY_ICON;
  PLAY_PAUSE_BTN.addEventListener("click", togglePlaying);
  RESET_BTN.addEventListener("click", reset)
})();

function togglePlaying() {
  isPlaying = !isPlaying;
  isPlaying ? startContext() : stopContext();
  AUDIO_BLOCKS.forEach(isPlaying ? playTrack : pauseTrack);
  PLAY_PAUSE_BTN.innerHTML = isPlaying ? PAUSE_ICON : PLAY_ICON;
}

function getVisual(el) {
  return el.children[0];
}

function getAudioTrack(el) {
  return el.children[1];
}

function playTrack(block) {
  const id = block.id;
  const visualToChange = getVisual(block);
  const music = getAudioTrack(block);
  music.play();
  const analyser = sources[id];
  animationIds[id] = getNextFrame(id, visualToChange, analyser);
  document.body.style.cursor = "none"
  if (LOADING_SCREEN.style.display === "flex") LOADING_SCREEN.style.display = "none"

  music.addEventListener('waiting', function letLoad(e) {
    AUDIO_BLOCKS.forEach(pauseTrack);
    LOADING_SCREEN.style.display = "flex"
    music.addEventListener('canplay', () => {
      AUDIO_BLOCKS.forEach(playTrack)
      LOADING_SCREEN.style.display = "none"
    })
  })
  music.addEventListener("ended", function resetTrack(e) {
    e.target.currentTime = 0
    isPlaying = false
    PLAY_PAUSE_BTN.innerHTML = PLAY_ICON;
    document.body.style.cursor = "auto"
  })
}

function pauseTrack(block) {
  stopContext()
  getAudioTrack(block).pause();
  cancelAnimationFrame(animationIds[block.id]);
  PLAY_PAUSE_BTN.innerHTML = PLAY_ICON;
  document.body.style.cursor = "auto"
}

function reset() {
  if (isPlaying) AUDIO_BLOCKS.forEach(pauseTrack)
  AUDIO_BLOCKS.forEach(function resetTrack(block) {
    const id = block.id
    const music = getAudioTrack(block)
    const visualToChange = getVisual(block)
    music.currentTime = 0
    const timer = setTimeout(() => {
      if (id === 'hiHat') {
        visualToChange.style.opacity = 0
        GLASS.style.opacity = 0
        STARS.style.opacity = 0
      } else if (id === "kick") {
        visualToChange.style.transform = `translateX(-50%) scale(0)`;
        visualToChange.style.opacity = 0
        visualToChange.style.filter = `saturate(0%)`
      } else if (id === "snare") {
        visualToChange.style.transform = `scale(0)`;
        visualToChange.style.filter = `saturate(0%)`
      } else if (id === "bass") {
        visualToChange.style.transform = `translateX(-50%) scale(0)`;
        visualToChange.style.opacity = 0
      } else if (id === "cymbal") {
        visualToChange.style.filter = `contrast(0%)`
        visualToChange.style.transform = `translateX(-50%) scale(0)`;
      } else if (id === "synths") {
        visualToChange.style.backgroundColor = "#000000"
        visualToChange.style.opacity = 0
      } 
      clearTimeout(timer)
    }, 300)
  })
}

function getNextFrame(id, visualToChange, analyser) {
  const fbcArray = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(fbcArray);
  const average = fbcArray.reduce((accum, val) => accum + val, 0) / fbcArray.length;
  if (id === 'hiHat') {
    const freqCutoff = (Math.floor(fbcArray.length/3) * 2) - 150
    const averageForStars = fbcArray.slice(0, freqCutoff).reduce((accum, val) => accum + val, 0) / (fbcArray.length/2);
    const averageForGlass = fbcArray.slice(freqCutoff).reduce((accum, val) => accum + val, 0) / (fbcArray.length/2);
    const glassOpacity = (averageForGlass / 200) * SCALES[id]
    const starsOpacity = (averageForStars / 600) * SCALES[id]
    console.log('glass:', glassOpacity)
    console.log('stars:', starsOpacity)
    GLASS.style.opacity = glassOpacity
    STARS.style.opacity = starsOpacity - glassOpacity
  } else {
    if (id === "kick") {
      visualToChange.style.transform = `translateX(-50%) scale(${average * SCALES[id]})`;
      visualToChange.style.opacity = (average / 10) * SCALES[id]
      visualToChange.style.filter = `saturate(${average * (SCALES[id] * 50)}%)`
    } else if (id === "snare") {
      visualToChange.style.transform = `scale(${average * SCALES[id]})`;
      visualToChange.style.opacity = (average / 10) * SCALES[id]
      visualToChange.style.filter = `saturate(${average * (SCALES[id] * 20)}%)`
    } else if (id === "bass") {
      visualToChange.style.transform = `translateX(-50%) scale(${average * SCALES[id]})`;
      visualToChange.style.opacity = (average / 10) * SCALES[id]
    } else if (id === "cymbal") {
      visualToChange.style.filter = `contrast(${average * (SCALES[id] * 20)}%)`
      visualToChange.style.transform = `translateX(-50%) scale(${average * SCALES[id]})`;
    } else if (id === "synths") {
      visualToChange.style.backgroundColor = generateColor((average * SCALES[id]) % 12)
      visualToChange.style.opacity = (average / 100) * SCALES[id]
    }
  } 
  if (isPlaying) {
    requestAnimationFrame(() => getNextFrame(id, visualToChange, analyser));
  }
}

function startContext() {
  context.resume();
}

function stopContext() {
  context.suspend();
}

function generateColor(step) {
  // based on http://stackoverflow.com/a/7419630
  // Adam Cole, 2011-Sept-14
  let red = 0, green = 0, blue = 0;
  const hue = step * 6
  const i = ~~hue;
  const f = hue - i;
  const q = 1 - f;
  switch(i % 6){
    case 0: red = 1, green = f, blue = 0; break;
    case 1: red = q, green = 1, blue = 0; break;
    case 2: red = 0, green = 1, blue = f; break;
    case 3: red = 0, green = q, blue = 1; break;
    case 4: red = f, green = 0, blue = 1; break;
    case 5: red = 1, green = 0, blue = q; break;
  }
  const redHex = generateHex(red)
  const greenHex = generateHex(green)
  const blueHex = generateHex(blue)
  const color = "#" + redHex + greenHex + blueHex;
  return color;
}

function generateHex(step) {
  return ("00" + (~ ~(step * 235)).toString(16)).slice(-2);
}

</script>
</html>